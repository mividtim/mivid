{"version":3,"file":"auth.js","sources":["auth.coffee"],"names":[],"mappings":"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","sourcesContent":["assign = require \"lodash.assign\"\nAuth0Lock = require(\"auth0-lock\").default\nrequire \"bluebird\"\ngraphql = require \"./graphql\"\njwt = require \"jsonwebtoken\"\n\nactionTypes =\n  login:\n    request: \"AUTH_LOGIN_REQUEST\"\n    success: \"AUTH_LOGIN_SUCCESS\"\n    fail: \"AUTH_LOGIN_FAIL\"\n  getUser:\n    request: \"AUTH_USER_REQUEST\"\n    success: \"AUTH_USER_SUCCESS\"\n    fail: \"AUTH_USER_FAIL\"\n\ninit = (auth0ClientId, auth0Domain) ->\n  @auth0ClientId = auth0ClientId\n  @auth0Domain = auth0Domain\n\nactions =\n  login: ->\n    redux = require \"./redux\"\n    (dispatch) ->\n      dispatch type: actionTypes.login.request\n      lock = new Auth0Lock @auth0ClientId, @auth0Domain,\n        theme:\n          logo: \"https://chirptag.herokuapp.com/icon/apple-icon-57x57.png\"\n          primaryColor: \"#86748e\"\n      lock.show()\n      lock.on \"authenticated\", (authResult) ->\n        localStorage.setItem \"authToken\", token\n        dispatch redux.actions.auth.loggedIn authResult.idToken\n  loggedIn: (token) -> {\n    type: actionTypes.login.success\n    token\n    clientId: jwt.decode(token).sub\n  }\n  getUser: ->\n    (dispatch, getState) ->\n      state = getState()\n      if not state.gettingUser\n        dispatch type: actionTypes.getUser.request\n        graphql(getState()).query \"\"\"\n          query user($clientId: String) {\n            user(clientId: $clientId) {\n              id\n              clientId\n              person {\n                name\n                email\n                mobile\n                pictureURL\n              }\n            }\n          }\n          \"\"\",\n          clientId: state.auth.clientId\n        .then (response) ->\n            dispatch\n              type: actionTypes.getUser.success\n              user: response.data.user\n        .catch (error) -> dispatch {type: actionTypes.getUser.fail, error}\n\ntoken = localStorage.getItem \"authToken\"\nclientId = null\nif token?\n  decoded = jwt.decode token\n  if not decoded? or not decoded.sub? or Date.now() / 1000 > decoded.exp\n    localStorage.removeItem \"authToken\"\n    token = null\n  else\n    clientId = decoded.sub\ninitialState = {\n  loggingIn: no\n  authorized: token?\n  token\n  clientId\n  gettingUser: no\n  user: null\n  error: null\n}\nreducer = (state = initialState, action) ->\n  switch action.type\n    when actionTypes.login.request\n      assign {}, state,\n        loggingIn: yes\n        authorized: no\n        token: null\n        clientId: null\n    when actionTypes.login.success\n      assign {}, state,\n        loggingIn: no\n        authorized: yes\n        token: action.token\n        clientId: action.clientId\n    when actionTypes.login.fail\n      assign {}, state,\n        loggingIn: no\n        error: action.error\n    when actionTypes.getUser.request\n      assign {}, state,\n        gettingUser: yes\n        user: null\n    when actionTypes.getUser.success\n      assign {}, state,\n        gettingUser: no\n        user: action.user\n    when actionTypes.getUser.fail\n      assign {}, state,\n        #gettingUser: no\n        error: action.error\n    else state\n\nmodule.exports = {\n  init\n  actions\n  reducer\n}\n"]}